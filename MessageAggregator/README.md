# Message Aggregator

**Message Aggregator** — система для создания кратких сводок из множества сообщений в чатах с помощью искусственного интеллекта (OpenAI GPT-4). Проект состоит из backend (на .NET), frontend (на React + TypeScript) и использует PostgreSQL для хранения данных.

---

## Содержание

- [Описание проекта](#описание-проекта)
- [Архитектура и структура репозитория](#архитектура-и-структура-репозитория)
- [Требования к окружению](#требования-к-окружению)
- [Установка и запуск](#установка-и-запуск)
  - [База данных (PostgreSQL)](#база-данных-postgresql)
  - [Backend (.NET)](#backend-net)
  - [Frontend (React)](#frontend-react)
- [Настройка переменных окружения](#настройка-переменных-окружения)
- [Интеграция и авторизация через Telegram](#интеграция-и-авторизация-через-telegram)
  - [Создание Telegram-бота](#создание-telegram-бота)
  - [Добавление бота в группу или канал](#добавление-бота-в-группу-или-канал)
  - [Получение chat_id](#получение-chat_id)
  - [Настройка backend для Telegram](#настройка-backend-для-telegram)
  - [Авторизация пользователя через Telegram](#авторизация-пользователя-через-telegram)
- [Как пользоваться системой](#как-пользоваться-системой)
- [Описание API и моделей](#описание-api-и-моделей)
- [Docker](#docker)
- [Безопасность и советы](#безопасность-и-советы)
- [Решение типовых проблем](#решение-типовых-проблем)

---

## Описание проекта

Message Aggregator позволяет собирать сообщения из чатов Telegram, автоматически формировать по ним краткие сводки с помощью искусственного интеллекта (OpenAI GPT-4) и сохранять их для дальнейшего анализа. Система состоит из backend (API на .NET), frontend (React), базы данных PostgreSQL и интеграции с Telegram.

---

## Архитектура и структура репозитория

- `MessageAggregator/` — backend (бизнес-логика, сервисы, модели, работа с БД)
- `WebApi/` — backend API (контроллеры, точка входа, настройки)
- `frontend/` — клиентская часть (React-приложение)
- `docker-compose.yml` — запуск сервисов (Postgres)
- `README.md` — документация

---

## Требования к окружению

- .NET 7+
- Node.js 18+
- npm 9+
- Docker (для запуска БД)
- Аккаунт Telegram

---

## Установка и запуск

### База данных (PostgreSQL)

1. Убедитесь, что Docker установлен.
2. Запустите БД командой:
   ```
   docker-compose up -d
   ```
   По умолчанию будет создана база `message_aggregator` с пользователем `appuser` и паролем `apppassword` (см. `docker-compose.yml`).

### Backend (.NET)

1. Перейдите в корень проекта.
2. Установите зависимости:
   ```
   dotnet restore
   ```
3. Примените миграции к БД:
   ```
   dotnet ef database update
   ```
4. Запустите API:
   ```
   dotnet run --project WebApi/WebApi.csproj
   ```
   По умолчанию API будет доступен на http://localhost:5000 (или другом порту, если настроено иначе).

### Frontend (React)

1. Перейдите в папку `frontend`:
   ```
   cd frontend
   ```
2. Установите зависимости:
   ```
   npm install
   ```
3. Запустите dev-сервер:
   ```
   npm start
   ```
   Приложение будет доступно на http://localhost:3000

---

## Настройка переменных окружения

В файле `WebApi/appsettings.Development.json` или через переменные окружения укажите:

```json
"ConnectionStrings": {
  "DefaultConnection": "Host=localhost;Port=5432;Database=message_aggregator;Username=appuser;Password=apppassword"
},
"OpenAI": {
  "ApiKey": "ВАШ_OPENAI_API_KEY",
  "Endpoint": "https://api.openai.com/v1/chat/completions",
  "Model": "gpt-4o"
},
"Telegram": {
  "BotToken": "ВАШ_TELEGRAM_BOT_TOKEN",
  "DefaultChatId": "ВАШ_CHAT_ID"
}
```

---

## Интеграция и авторизация через Telegram

### Создание Telegram-бота

1. Откройте Telegram и найдите пользователя [@BotFather](https://t.me/BotFather).
2. Введите команду `/newbot` и следуйте инструкциям:
   - Придумайте имя и username для бота (username должен оканчиваться на `bot`).
   - После создания вы получите токен вида `123456:ABC-DEF1234ghIkl-zyx57W2v1u123ew11`.
3. Сохраните токен — он потребуется для настройки backend.

### Добавление бота в группу или канал

1. Откройте нужную группу или канал в Telegram.
2. В настройках группы выберите "Добавить участника" и найдите вашего бота по username.
3. Добавьте бота в группу.
4. Для получения сообщений из группы бот должен быть назначен администратором (разрешить чтение сообщений).

### Получение chat_id

1. Отправьте любое сообщение в группу/канал, куда добавлен бот.
2. Используйте сервисы типа [userinfobot](https://t.me/userinfobot) или специальные Telegram-боты для получения chat_id, либо:
   - Включите логирование в backend, чтобы увидеть chat_id при первом обращении.
   - Либо используйте Telegram Bot API: отправьте запрос `getUpdates` на `https://api.telegram.org/bot<ВАШ_ТОКЕН>/getUpdates` и найдите chat_id в ответе.

### Настройка backend для Telegram

1. Откройте файл `appsettings.Development.json` или используйте переменные окружения.
2. Укажите:
   - Токен Telegram-бота.
   - chat_id (если требуется явно).
   - Строку подключения к БД.
   - Ключ OpenAI.

### Авторизация пользователя через Telegram

1. Откройте frontend-приложение в браузере (обычно http://localhost:3000).
2. На главной странице найдите и нажмите кнопку "Войти через Telegram" или "Авторизация через Telegram".
3. Откроется официальный Telegram-виджет:
   - Введите номер телефона, подтвердите вход.
   - Разрешите передачу данных приложению.
4. После успешной авторизации вы будете автоматически возвращены в приложение, где появится ваш Telegram-аккаунт и список доступных чатов.

---

## Как пользоваться системой

1. **Запуск системы**
   - Убедитесь, что PostgreSQL запущен (через `docker-compose up -d`).
   - Запустите backend и frontend (см. выше).

2. **Авторизация через Telegram**
   - Войдите через Telegram, следуя инструкции выше.

3. **Выбор чата**
   - После авторизации появится список доступных чатов.
   - Выберите интересующий чат для анализа.

4. **Создание сводки**
   - Нажмите кнопку "Сделать сводку" или аналогичную.
   - Система отправит сообщения выбранного чата на backend, где AI (OpenAI GPT-4) сформирует краткую сводку.
   - Сводка появится на экране, её можно скопировать или сохранить.

5. **Просмотр истории**
   - В разделе "История" можно просмотреть ранее созданные сводки.

6. **Анализ данных (DCA)**
   - Если реализован функционал DCA, выберите соответствующий раздел и следуйте инструкциям интерфейса.

---

## Описание API и моделей

### Основные сервисы и компоненты

- **TelegramService** — интеграция с Telegram, получение сообщений из чатов.
- **AiService** — взаимодействие с OpenAI GPT-4 для генерации сводок.
- **DcaService** — работа с сущностями Summary.
- **AppDbContext** — работа с базой данных через Entity Framework Core.

### Модели и DTO

- **User** — пользователь системы.
- **Summary** — сводка по сообщениям.
- **ChatMessageDto** — DTO для сообщений чата.
- **AiSummaries, AiAnalysisResultDto** — результаты анализа AI.

### API (основные endpoints)

- `/api/telegram/getallchats` — получить все чаты пользователя.
- `/api/telegram/summarizechat` — получить сводку по сообщениям чата.
- `/api/dca/analyze` — анализ данных (DCA).

---

## Docker

- Для запуска только БД:  
  ```
  docker-compose up -d
  ```
- Для запуска backend через Docker: раскомментируйте webapi в `docker-compose.yml` и выполните  
  ```
  docker-compose up --build
  ```
- Переменные окружения для БД должны совпадать с настройками в `appsettings.Development.json`.

---

## Безопасность и советы

- Никогда не публикуйте токен бота и ключ OpenAI в открытом доступе.
- Авторизация происходит через официальный Telegram-виджет, пароли не сохраняются.
- Все данные пользователя используются только для работы приложения.
- Рекомендуется использовать отдельного пользователя и БД для production.

---

## Решение типовых проблем

- **Бот не отвечает**: проверьте токен, права бота, доступность backend.
- **Нет чатов**: убедитесь, что бот добавлен в нужные группы и назначен администратором.
- **Ошибка авторизации**: проверьте интернет-соединение, корректность токена, настройки CORS на backend.
- **Ошибка подключения к БД**: проверьте параметры подключения и статус контейнера Postgres.
- **OpenAI не отвечает**: проверьте валидность ключа и лимиты аккаунта.

---

## Пример .env (если потребуется)

```
POSTGRES_DB=message_aggregator
POSTGRES_USER=appuser
POSTGRES_PASSWORD=apppassword
OPENAI_API_KEY=...
TELEGRAM_BOT_TOKEN=...
```

---

**Если возникнут вопросы или потребуется помощь — обратитесь к разработчику или создайте issue в репозитории.**
